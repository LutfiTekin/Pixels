<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gallery</title>
  <style>
    body { font-family: sans-serif; margin: 0; background: #111; color: #fff; }
    .container { padding: 1rem; max-width: 1000px; margin: auto; }
    .album-title { font-size: 2rem; margin-bottom: 0.5rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
    .grid img { width: 100%; cursor: pointer; border-radius: 8px; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
             background: rgba(0,0,0,0.9); justify-content: center; align-items: center; flex-direction: column; z-index: 999; }
    .modal img { max-width: 90%; max-height: 70vh; margin-bottom: 1rem; }
    .modal-content { text-align: center; max-width: 600px; }
    .modal-buttons { margin-top: 1rem; }
    .modal button { margin: 0 1rem; padding: 0.5rem 1rem; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <div id="error" class="hidden">Album not found or not specified.</div>
    <div id="gallery" class="hidden">
      <div class="album-title" id="albumTitle"></div>
      <div class="grid" id="grid"></div>
    </div>
  </div>

  <div class="modal" id="modal">
    <img id="modalImage" src="" alt="">
    <div class="modal-content">
      <h2 id="modalTitle"></h2>
      <p id="modalDesc"></p>
      <div class="modal-buttons">
        <button id="prevBtn">← Prev</button>
        <button id="downloadBtn">Download</button>
        <button id="nextBtn">Next →</button>
      </div>
    </div>
  </div>

  <script>
    const qs = new URLSearchParams(location.search);
    const albumId = qs.get('album');
    const selectedId = qs.get('selected');
    const galleryEl = document.getElementById('gallery');
    const errorEl = document.getElementById('error');
    const gridEl = document.getElementById('grid');
    const modal = document.getElementById('modal');
    const modalImage = document.getElementById('modalImage');
    const modalTitle = document.getElementById('modalTitle');
    const modalDesc = document.getElementById('modalDesc');
    const downloadBtn = document.getElementById('downloadBtn');

    let albumData = null;
    let imageMeta = {};
    let currentIndex = -1;

    async function loadJSON(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error('Failed to load ' + url);
      return res.json();
    }

    async function init() {
      if (!albumId) return errorEl.classList.remove('hidden');

      try {
        const albums = await loadJSON('albums.json');
        const metadata = await loadJSON('images.json');
        if (!albums[albumId]) return errorEl.classList.remove('hidden');

        albumData = albums[albumId];
        imageMeta = metadata;
        renderGallery(albumData.images, albumData.title || '', albumData.description || '');
        galleryEl.classList.remove('hidden');

        if (selectedId) {
          const index = albumData.images.indexOf(selectedId);
          if (index !== -1) openModal(index);
        }
      } catch (e) {
        console.error(e);
        errorEl.classList.remove('hidden');
      }
    }

    function renderGallery(ids, title, desc) {
      document.getElementById('albumTitle').textContent = title;
      gridEl.innerHTML = '';
      ids.forEach((id, idx) => {
        const url = `images/${albumId}/${id}.png`;
        const img = document.createElement('img');
        img.src = url;
        img.alt = imageMeta[id]?.title || '';
        img.onclick = () => openModal(idx);
        gridEl.appendChild(img);
      });
    }

    function openModal(index) {
      currentIndex = index;
      const id = albumData.images[index];
      const meta = imageMeta[id] || {};
      const imgUrl = `images/${albumId}/${id}.png`;

      modalImage.src = imgUrl;
      modalTitle.textContent = meta.title || '';
      modalDesc.textContent = meta.description || '';
      downloadBtn.onclick = () => {
        const a = document.createElement('a');
        a.href = imgUrl;
        a.download = id + '.png';
        a.click();
      };

      modal.style.display = 'flex';
      history.replaceState(null, '', `?album=${albumId}&selected=${id}`);
    }

    function navigate(offset) {
      const newIndex = currentIndex + offset;
      if (newIndex >= 0 && newIndex < albumData.images.length) {
        openModal(newIndex);
      }
    }

    document.getElementById('prevBtn').onclick = () => navigate(-1);
    document.getElementById('nextBtn').onclick = () => navigate(1);
    modal.onclick = e => { if (e.target === modal) modal.style.display = 'none'; };

    document.addEventListener('keydown', e => {
      if (!modal.style.display.includes('flex')) return;
      if (e.key === 'ArrowLeft') navigate(-1);
      if (e.key === 'ArrowRight') navigate(1);
      if (e.key === 'Escape') modal.style.display = 'none';
    });

    init();
  </script>
</body>
</html>